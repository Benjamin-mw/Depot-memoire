---
title: "cart"
output: html_document
date: "2023-02-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cart

```{r}
install.packages("rpart")
install.packages("rpart.plot")
install.packages("CASdatasets", repos = "http://dutangc.perso.math.cnrs.fr/RRepository/", type="source")
install.packages("CASdatasets", repos = "http://dutangc.free.fr/pub/RRepos/", type="source")
install.packages("CASdatasets", repos = "http://cas.uqam.ca/pub/", type="source")

#library(CASdatasets)
install.packages("rpart")
install.packages("partykit")
library(rpart)
library(partykit)
install.packages("devtools")
devtools::install_github("dutangc/CASdatasets", subdir="pkg")
library(CASdatasets)


install.packages("xts")
install.packages("sp")
install.packages("zoo")
```

```{r}
library(rpart)
library(rpart.plot)
library(sp)
library(CASdatasets)
```

```{r}
data(freMPL5)

perm <- sample(nrow(freMPL5),80/100*nrow(freMPL5))
freMPL5.train <- freMPL5[perm,]
freMPL5.test <- freMPL5[-perm,]
```

```{r}
freMPL5.train <- subset(freMPL5.train, freMPL5.train$ClaimAmount >= 0)
freMPL5.train$HasKmLimit <- factor(freMPL5.train$HasKmLimit)
freMPL5.train$RiskArea <- factor(freMPL5.train$RiskArea)
freMPL5.train$ClaimInd <- factor(freMPL5.train$ClaimInd)



#Pour faire une analyse de données, nous allons transformer toutes les variables
#quantitatives en variables qualitatives de manière à avoir un nombre homogènes
#d'assurés dans chaque classe.
freMPL5.train$DrivAge_fact <- cut(freMPL5.train$DrivAge, c(20,25,30,35,40,45,50,58,65,120), include.lowest = TRUE)

freMPL5.train$BonusMalus <- cut(freMPL5.train$BonusMalus, c(50,54,seq(60, 200, 20)), include.lowest = TRUE)
```

```{r}
freMPL5.test <- subset(freMPL5.test, freMPL5.test$ClaimAmount >= 0)
freMPL5.test$HasKmLimit <- factor(freMPL5.test$HasKmLimit)
freMPL5.test$RiskArea <- factor(freMPL5.test$RiskArea)
freMPL5.test$ClaimInd <- factor(freMPL5.test$ClaimInd)



#Pour faire une analyse de données, nous allons transformer toutes les variables
#quantitatives en variables qualitatives de manière à avoir un nombre homogènes
#d'assurés dans chaque classe.
freMPL5.test$DrivAge_fact <- cut(freMPL5.test$DrivAge, c(20,25,30,35,40,45,50,58,65,120), include.lowest = TRUE)


freMPL5.test$BonusMalus <- cut(freMPL5.test$BonusMalus, c(50,54,seq(60, 200, 20)), include.lowest = TRUE)
```


```{r}
#étape de construction de l'arbre maximal
freMPL5.Tree.Amount <- rpart(ClaimAmount~MariStat+SocioCateg+VehUsage+HasKmLimit+ClaimNbResp+ClaimNbNonResp+ClaimNbParking+ClaimNbFireTheft+ClaimNbWindscreen+OutUseNb+RiskArea+BonusMalus+DrivAge_fact,
                      data=freMPL5.train,
                      control=rpart.control(xval = 10, minbucket = 150,cp=0))
rpart.plot(freMPL5.Tree.Amount)


```
```{r}
#On utilise plotcp pour afficher la courbe du taux d'erreur relatif en fonction des cp, on choisi un cp qui minimise ce taux d'erreur pour une taille correcte
plotcp(freMPL5.Tree.Amount)
printcp(freMPL5.Tree.Amount)
```


```{r}
#étape d'élagage de l'arbre avec un cp qui minimise le taux d'erreur relatif tout en donnant un arbre de taille correcte
freMPL5.Tree.prune.Amount=prune(freMPL5.Tree.Amount,cp=0.00095)
rpart.plot(freMPL5.Tree.prune.Amount)
```

```{r}
#calcul de l'erreur quadratique moyenne
pred <- predict(freMPL5.Tree.prune.Amount, newdata = freMPL5.test)
mse <- mean((pred - freMPL5.test$ClaimAmount)^2)
mse

```

---
title: "glmtreeCLAIM"
output: html_document
date: "2023-04-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rpart)
library(rpart.plot)
library(sp)
library(CASdatasets)
library(party)
library(partykit)
```


```{r}
data(freMPL5)
#Création d'une variable de sinistralité
freMPL5$Sinistres = freMPL5$ClaimInd/freMPL5$Exposure
freMPL5$Sinistres2 = round(freMPL5$Sinistres)

#Ajustement type des variables
freMPL5$HasKmLimit <- factor(freMPL5$HasKmLimit)
freMPL5$RiskArea <- factor(freMPL5$RiskArea)
freMPL5$OutUseNb <- as.numeric(freMPL5$OutUseNb)
#Suppression des valeurs négatives
freMPL5 <- subset(freMPL5, freMPL5$ClaimAmount >= 0)
#Segmentation des tranches d'âge
freMPL5$DrivAge_fact <- cut(freMPL5$DrivAge, c(20,25,30,35,40,45,50,58,65,120), include.lowest = TRUE)
#Découpage CSP
freMPL5$Categ = 0
freMPL5$Categ[freMPL5$SocioCateg == "CSP50"] = 1
freMPL5$Categ[freMPL5$SocioCateg == "CSP55"] = 2
freMPL5$Categ[freMPL5$SocioCateg == "CSP60"] = 3
freMPL5$Categ[freMPL5$SocioCateg == "CSP1"] = 4
freMPL5$Categ[freMPL5$SocioCateg == "CSP42"] = 5
freMPL5$Categ[freMPL5$SocioCateg == "CSP46"] = 6
freMPL5$Categ[freMPL5$SocioCateg == "CSP48"] = 7
freMPL5$Categ[freMPL5$SocioCateg == "CSP66"] = 8
freMPL5$Categ = factor(freMPL5$Categ)
```

```{r}


set.seed(123) 
train.index <- sample(1:nrow(freMPL5), size=0.7*nrow(freMPL5), replace=FALSE)
trainGLM.data1 <- freMPL5[train.index,]
testGLM.data1 <- freMPL5[-train.index,]
```

```{r}
glm_tree_bin <- glmtree(ClaimInd ~ MariStat+SocioCateg+VehUsage+HasKmLimit+ClaimNbResp+ClaimNbNonResp+ClaimNbParking+ClaimNbFireTheft+ClaimNbWindscreen+OutUseNb+RiskArea+BonusMalus+DrivAge_fact,
  data = trainGLM.data1 , maxdepth = 4, family = binomial(link = logit))
plot(glm_tree_bin)

```



```{r}

AIC(glm_tree_bin)
BIC(glm_tree_bin)
```

```{r}

prediction <- predict(glm_tree_bin, newdata = testGLM.data1)
mse <- mean((prediction - testGLM.data1$ClaimAmount)^2)
mse
```

```{r}
table(prediction, testGLM.data1$ClaimInd)
```



```{r}
glm_tree_poi <- glmtree(Sinistres2 ~ MariStat+Categ+VehUsage+HasKmLimit+ClaimNbResp+ClaimNbNonResp+ClaimNbParking+ClaimNbFireTheft+ClaimNbWindscreen+OutUseNb+RiskArea+BonusMalus+DrivAge_fact,
  data = trainGLM.data1 , maxdepth = 4, family = poisson)
plot(glm_tree_poi)

```

```{r}

AIC(glm_tree_poi)
BIC(glm_tree_poi)
```


```{r}

prediction2 <- predict(glm_tree_poi, newdata = testGLM.data1)
mse <- mean((prediction2 - testGLM.data1$Sinistres2)^2)
mse
```

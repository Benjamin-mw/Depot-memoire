---
title: "Analyse des données"
output: html_document
date: "2023-01-19"
---

## Import de packages utiles

```{r}
library(FactoMineR)
library(factoextra)
library(CASdatasets)
library(tidyverse)
library(MASS)
library(knitr)
library(ggplot2)
library(cowplot)
library(reshape2)
library(dplyr)
library(GGally)
library(corrplot)
library(carData) 
library(car)
library(questionr)
library(multcomp)
library(dplyr)
library(leaps)
library(TeachingDemos)
library(FactoMineR)
library(factoextra)
library(ROCR)
library(plotROC)
```

## Documentation et import du dataset

```{r}
?CASdatasets #ouvre l'aide pour comprendre le dataset

data(freMPL5)

summary(freMPL5)

#Cette nouvelle covariable sera présentée plus tard
freMPL5$ObtLic <- ceiling(freMPL5$DrivAge - freMPL5$LicAge/12)

x <- freMPL5[, c(1,2,9,11,12,13,14,15,16,17,18,19,20,21)]
corrplot(round(cor(x),2),method="ellipse")
```

freMPL veut dire French Motor Personal Line datasets. On utilisera le dataset 5 qui contient environ 26000 contrats de l'annee 2004.

On a ici un premier résumé des variables avec des premières corrélations uniquement pour les variables continues.

On voit des fortes corrélations en valeur absolue entre BonusMalus, DrivAge et LicAge. Cela peut facilement se comprendre car l'âge du conducteur et le temps écoulé depuis qu'il a obtenu son permis sont souvent fortement lié. On pourrait d'ailleurs éventuellement créer une variable pour connaitre l'âge du conducteur lorsqu'il a obtenu le permis.

On remarque que certaines variables sont numériques au lieu d'être considérées comme des facteurs. Nous allons donc les changer :

```{r}
freMPL5$HasKmLimit <- factor(freMPL5$HasKmLimit)
freMPL5$ClaimInd <- factor(freMPL5$ClaimInd)
freMPL5$RiskArea <- factor(freMPL5$RiskArea)
#freMPL5$ClaimNbResp <- factor(freMPL5$ClaimNbResp)
#freMPL5$ClaimNbNonResp <- factor(freMPL5$ClaimNbNonResp)
#freMPL5$ClaimNbParking <- factor(freMPL5$ClaimNbParking)
#freMPL5$ClaimNbFireTheft <- factor(freMPL5$ClaimNbFireTheft)
#freMPL5$ClaimNbWindscreen <- factor(freMPL5$ClaimNbWindscreen)
#freMPL5$OutUseNb <- factor(freMPL5$OutUseNb)
```

### Coefficient de bonus-malus

Pour le coefficient de bonus-malus, il commence à 1 et peut descendre jusqu'à 0.5 si le conducteur n'a pas d'accidents responsables ou semi-responsables. A l'inverse, en cas d'accidents responsables, le coefficient augmente et peut atteindre jusqu'à 3.5. Dans le jeu de données, toutes les valeurs sont multipliées par 100 ce qui ne posera aucun problème dans le cas de nos modèles. Cependant, si on veut voir l'impact linéaire du coefficient de bonus-malus, il pourrait être intéressant de revoir son échelle en retranchant 100 par exemple à la variable. C'est pour cela qu'il y a une corrélation assez importante entre BonusMalus et ClaimNbResp.

Dans notre jeu de données, la valeur maximale est 1.85. Nous n'avons donc aucune information sur des éventuels assurés possédant un malus supérieur. Cela pourra donc être compliqué de prédire les primes d'assurances pour ce genre d'assurés. De manière générale, ici on a princialement des bons conducteurs puisque la médianne vaut 0.5 et le 3eme quartile 0.6 et 95% des assurés sont en dessous de 0.90.

```{r}
summary(freMPL5$BonusMalus)

quantile(freMPL5$BonusMalus, seq(0,1,0.05))
```

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$BonusMalus)
boxplot(freMPL5$BonusMalus ~ freMPL5$ClaimInd)
hist(freMPL5$BonusMalus[freMPL5$ClaimInd == 0])
hist(freMPL5$BonusMalus[freMPL5$ClaimInd == 1])

fact_BonusMalus <- cut(freMPL5$BonusMalus, c(50,seq(51,120,10),350), include.lowest = TRUE)
tab <- table(fact_BonusMalus, freMPL5$ClaimInd)
cols <- rainbow(nlevels(freMPL5$ClaimInd))
plot(tab,col = cols)
```

C'est surtout le boxplot qui permet de conclure à un lien car ceux qui ont à réclamer de l'argent ont en moyenne un Bonus plus faible que les autres.

##### Etude par rapport au coût

```{r}
boxplot(freMPL5$ClaimAmount ~ fact_BonusMalus, ylim=c(0,6000))
fact_BonusMalus_sinistre <- cut(freMPL5$BonusMalus[freMPL5$ClaimInd == 1], c(seq(50,59,1),seq(60,120,10),350), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1] ~ fact_BonusMalus_sinistre, ylim=c(0,15000))
```

Le premier graphique n'étant pas interprétable, nous avons créé le deuxieme qui semble nous donner une certaine tendance : plus le coefficient de malus est élevé et plus le coût moyen augmente.

# Covariables liées à l'âge

### Etude de la variable d'âge (DrivAge)

```{r}
summary(freMPL5$DrivAge)
```

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$DrivAge)
hist(freMPL5$DrivAge[freMPL5$ClaimInd == 0])
summary(freMPL5$DrivAge[freMPL5$ClaimInd == 0])

hist(freMPL5$DrivAge[freMPL5$ClaimInd == 1])
summary(freMPL5$DrivAge[freMPL5$ClaimInd == 1])

boxplot(freMPL5$DrivAge ~ freMPL5$ClaimInd)

ggplot(freMPL5, aes(x = DrivAge)) +
  geom_histogram(aes(color = ClaimInd, fill = ClaimInd), 
                position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

```{r}
freMPL5$DrivAge <- cut(freMPL5$DrivAge, c(20,25,30,35,40,45,50,58,65,120), include.lowest = TRUE)
tab <- table(freMPL5$DrivAge, freMPL5$ClaimInd)
cols <- rainbow(nlevels(freMPL5$ClaimInd))
plot(tab,col = cols)
```

L'âge du conducteur semble donc avoir un impact dans le risque d'avoir un sinistre (plus on est jeune, et plus on risque de coûter de l'argent à l'assurance). En effet, la proportion de 35-50 ans est très forte mais il n'y a pas beaucoup de sinistres comparé aux 20-30 ans.

##### Etude par rapport au coût

```{r}
plot(freMPL5$ClaimAmount ~ freMPL5$DrivAge)

boxplot(freMPL5$ClaimAmount ~ freMPL5$DrivAge)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimAmount>0] ~ freMPL5$DrivAge[freMPL5$ClaimAmount>0], ylim=c(0,6000))
```

On observe donc un risque accru pour les jeunes conducteurs mais on remarque aussi que le risque augmente de nouveau après 50 ans (cela pourrait correspondre au moment où les enfants sont en âge de conduire sur le véhicule des parents).

### Etude de la variable d'ancienneté du permis (LicAge)

Cette variable est exprimée en mois. Nous rappelons qu'elle est très corrélée avec DrivAge et Bonus-Malus.

```{r}
summary(freMPL5$LicAge)
```

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$LicAge)

summary(freMPL5$LicAge[freMPL5$ClaimInd == 0])

summary(freMPL5$LicAge[freMPL5$ClaimInd == 1])

boxplot(freMPL5$LicAge ~ freMPL5$ClaimInd)

ggplot(freMPL5, aes(x = LicAge)) +
  geom_histogram(aes(color = ClaimInd, fill = ClaimInd), 
                position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

```{r}
freMPL5$LicAge <- cut(freMPL5$LicAge, c(0,50,100,200,300,400,500,1000), include.lowest = TRUE)
tab <- table(freMPL5$LicAge, freMPL5$ClaimInd)
cols <- rainbow(nlevels(freMPL5$ClaimInd))
plot(tab,col = cols)
```

On retrouve à peu près les mêmes résultats ici que pour DrivAge. L'interprétation est la même.

##### Etude par rapport au coût

```{r}
plot(freMPL5$ClaimAmount ~ freMPL5$LicAge)
freMPL5$LicAge <- cut(freMPL5$LicAge, quantile(freMPL5$LicAge, probs = seq(0,1,1/6)), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount ~ freMPL5$LicAge)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimAmount>0] ~ freMPL5$LicAge[freMPL5$ClaimAmount>0], ylim=c(0,6000))
```

Idem que pour l'âge.

### Création d'une variable (ObtLic)

```{r}
#Rappel de la formule :
#freMPL5$ObtLic <- freMPL5$DrivAge - freMPL5$LicAge/12
summary(freMPL5$ObtLic)
```

On a des dates d'obtention de permis de 16 ans ? Ceci est étrange... Il faudra regarder dans les données :

```{r}
sum(ifelse(freMPL5$ObtLic<18,1,0))
```

Il n'y a que 13 valeurs incohérente, ce qui ne devrait pas beaucoup modifier l'analyse. Nous laisserons donc les données comme tel.

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$ObtLic)

summary(freMPL5$ObtLic[freMPL5$ClaimInd == 0])

summary(freMPL5$ObtLic[freMPL5$ClaimInd == 1])

boxplot(freMPL5$ObtLic ~ freMPL5$ClaimInd)

ggplot(freMPL5, aes(x = ObtLic)) +
  geom_histogram(aes(color = ClaimInd, fill = ClaimInd), 
                position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

Il ne semble pas y avoir ici d'impact particulier.

##### Etude par rapport au coût

```{r}
plot(freMPL5$ClaimAmount ~ freMPL5$ObtLic)
freMPL5$ObtLic <- cut(freMPL5$ObtLic, quantile(freMPL5$ObtLic, probs = seq(0,1,1/6)), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount ~ freMPL5$ObtLic)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimAmount>0] ~ freMPL5$ObtLic[freMPL5$ClaimAmount>0], ylim=c(0,6000))
```

Il n'y a pas de claire tendance une nouvelle fois. Cette variable ne sera sûrement pas utile par la suite.

# Covariables liées au temps et à l'exposition

### Exposition

```{r}
summary(freMPL5$Exposure)
```

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$Exposure)
hist(freMPL5$Exposure[freMPL5$ClaimInd == 0])
summary(freMPL5$Exposure[freMPL5$ClaimInd == 0])

hist(freMPL5$Exposure[freMPL5$ClaimInd == 1])
summary(freMPL5$Exposure[freMPL5$ClaimInd == 1])

boxplot(freMPL5$Exposure ~ freMPL5$ClaimInd)

ggplot(freMPL5, aes(x = Exposure)) +
  geom_histogram(aes(color = ClaimInd, fill = ClaimInd), 
                position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

Les résultats semblent très intuitifs puisque plus on prend un intervalle de temps grand et plus l'assuré a de risque d'avoir un accident.

##### Etude par rapport au coût

```{r}
fact_Exposure <- cut(freMPL5$Exposure, quantile(freMPL5$Exposure, probs = seq(0,1,1/6)), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount ~ fact_Exposure, ylim=c(0,6000))
fact_Exposure_sinistre <- cut(freMPL5$Exposure[freMPL5$ClaimInd == 1], quantile(freMPL5$Exposure[freMPL5$ClaimInd == 1], probs = seq(0,1,1/6)), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1] ~ fact_Exposure_sinistre, ylim=c(0,15000))
```

Sachant qu'on a eu un sinistre, on a alors que l'exposition n'est pas réellement impactant sur le coût des sinistres.

Nous étudierons cela plus en profondeur dans l'étude d'une éventuelle indépendance fréquence - coût moyen.

### Date de début

### Date de fin

# Covariables liées à l'état civil

### Genre

### Statut marital

### CSP

Cette catégorie devra être regroupée car elle contient trop de modalités de facteur.

# Covariables liées au véhicule ou à l'emplacement

### Utilisation du véhicule

### Limite kilométrique

### Zone de risque

Cette catégorie devra être regroupée (idem CSP)

# Covariables liées aux sinitres possibles

```{r}
cor.test(freMPL5$ClaimNbResp+freMPL5$ClaimNbNonResp+freMPL5$ClaimNbParking+freMPL5$ClaimNbFireTheft+freMPL5$ClaimNbWindscreen+freMPL5$OutUseNb, as.numeric(freMPL5$ClaimInd))

cor.test(freMPL5$ClaimNbResp+freMPL5$ClaimNbNonResp+freMPL5$ClaimNbParking+freMPL5$ClaimNbFireTheft+freMPL5$ClaimNbWindscreen+freMPL5$OutUseNb, as.numeric(freMPL5$ClaimInd), method = "kendall")

cor.test(freMPL5$ClaimNbResp+freMPL5$ClaimNbNonResp+freMPL5$ClaimNbParking+freMPL5$ClaimNbFireTheft+freMPL5$ClaimNbWindscreen+freMPL5$OutUseNb, as.numeric(freMPL5$ClaimAmount))

cor.test(freMPL5$ClaimNbResp+freMPL5$ClaimNbNonResp+freMPL5$ClaimNbParking+freMPL5$ClaimNbFireTheft+freMPL5$ClaimNbWindscreen+freMPL5$OutUseNb, as.numeric(freMPL5$ClaimAmount), method = "kendall")
```

En utilisant le test de Pearson et le test de Kendall, on obtient que la somme des sinitres possibles est corrélée avec l'indicateur ClaimInd mais aussi avec la variable ClaimAmount. Nous allons donc les étudier indépendament pour trouver l'impact de ces covariables sur les variables à expliquer.

### Accident responsable

```{r}
summary(freMPL5$ClaimNbResp)
quantile(freMPL5$ClaimNbResp, seq(0,1,1/10))
```

L'évènement d'avoir au moins un accident responsable est assez rare (environ 20%).

##### Etude par rapport à la sinistralité

```{r}
cor.test(freMPL5$ClaimNbResp, as.numeric(freMPL5$ClaimInd))

hist(freMPL5$ClaimNbResp)
boxplot(freMPL5$ClaimNbResp ~ freMPL5$ClaimInd)
hist(freMPL5$ClaimNbResp[freMPL5$ClaimInd == 0])
hist(freMPL5$ClaimNbResp[freMPL5$ClaimInd == 1])

ggplot(freMPL5, aes(x = ClaimNbResp)) +
  geom_histogram(aes(color = ClaimInd, fill = ClaimInd), 
                position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))


tab <- table(freMPL5$ClaimNbResp, freMPL5$ClaimInd)
cols <- rainbow(nlevels(freMPL5$ClaimInd))
plot(tab,col = cols)
```

Il y a ici aussi une grosse corrélation. Avec les graphiques, on remarque qu'il y a beaucoup plus d'indicateurs de réclamation positifs lorsque les accidents sont responsables.

##### Etude par rapport au coût

### Accident non-responsable

```{r}
summary(freMPL5$ClaimNbNonResp)
quantile(freMPL5$ClaimNbNonResp, seq(0,1,1/10))
```

L'évènement d'avoir au moins un accident non responsable est assez rare (environ 20%).

##### Etude par rapport à la sinistralité

##### Etude par rapport au coût

### Parking

```{r}
summary(freMPL5$ClaimNbParking)
quantile(freMPL5$ClaimNbParking, seq(0,1,1/20))
```

L'évènement d'avoir au moins un accident en se garant est très rare (environ 5%).

##### Etude par rapport à la sinistralité

##### Etude par rapport au coût

### Incendie ou vol

```{r}
summary(freMPL5$ClaimNbFireTheft)
quantile(freMPL5$ClaimNbFireTheft, seq(0,1,1/20))
```

L'évènement d'avoir un vol ou incendie de la voiture est très rare (environ 5%).

##### Etude par rapport à la sinistralité

##### Etude par rapport au coût

### Bris de glace

```{r}
summary(freMPL5$ClaimNbWindscreen)
quantile(freMPL5$ClaimNbWindscreen, seq(0,1,1/10))
```

L'évènement d'avoir au moins un bris de glace est relativement fréquent (environ 30%).

##### Etude par rapport à la sinistralité

##### Etude par rapport au coût

### Panne

```{r}
summary(freMPL5$OutUseNb)
quantile(freMPL5$OutUseNb, seq(0,1,1/20))
```

L'évènement d'avoir une panne est rare (environ 10%).

##### Etude par rapport à la sinistralité

##### Etude par rapport au coût

### Etude de la variables coût

##### ...en fonction de la sinistralité

```{r echo=TRUE}
plot(freMPL5$ClaimAmount ~ freMPL5$ClaimInd)
```

```{r echo=TRUE}
summary(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1]) #resumé lorsque de l'argent est demandé
summary(freMPL5$ClaimAmount[freMPL5$ClaimInd == 0])
```

On remarque donc l'apparition de quelques données étranges. En effet, on a l'apparition de variables de coût négatives. Ceci est du à une régularisation. ne pouvant pas traiter cela, nous supprimerons les lignes correspondantes qui sont au nombre de 278.

```{r}
sum(ifelse(freMPL5$ClaimAmount[freMPL5$ClaimInd == 0]<0,1,0)) #=278
```

Nous supprimons alors les lignes en questions :

```{r}
freMPL5 <- subset(freMPL5, freMPL5$ClaimAmount >= 0)
```

Nous avons autrement une distribution des coût qui est relativement proche de 0 avec tout de même l'apparition de quelques sinistres graves qui faussent la moyenne :

```{r}
hist(freMPL5$ClaimAmount) #écrasé par 0 car il y a énormément de petits sinistres
hist(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1]) #de nouveau écrasé dans les petites valeurs
```

Pour mieux voir la potentielle distribution, nous allons essayer de zoomer vers les petites valeurs :

```{r}
hist(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1], breaks=seq(0,100000,10),xlim=c(0,4000))
```

On a ici un graphique plus intéressant qui nous permettra de proposer éventuellement une loi pour la variable de coût. On remarque tout de fois quelques énormes pics de fréquence. Nous pouvons imaginer qu'il s'agit d'une dépense forfaitaire (comme par exemple un bris de glace qui s'en rapproche à cause de Carglass en France).

On remarque un premier pic entre 90 et 110 et un autre 1410 et 1420. Regardons à quoi cela pourrait être dû :

```{r}
summary(freMPL5[freMPL5$ClaimAmount<110 & freMPL5$ClaimAmount>90,])
```

On remarque que cette tranche représente 8,7% des assurés qui ont eu recours à un remboursement.

### Etude de la variable d'indication de remboursement

```{r}
summary(freMPL5[freMPL5$ClaimInd == 0,])
summary(freMPL5[freMPL5$ClaimInd == 1,])
```

On remarque que LicAge et DrivAge réduisent le risque d'avoir un sinistre.

De même, plus le score de malus est haut et plus l'assuré a de risque d'avoir un sinistre.

Avoir une limite de kilomètres semblent aussi réduire les risques.

Pour les catégories sociaux-professionnelles, il faudra faire une étude plus poussée avant de conclure.

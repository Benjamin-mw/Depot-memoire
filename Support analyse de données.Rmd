---
title: "Analyse des données"
output: html_document
date: "2023-01-19"
---

## Import de packages utiles

```{r}
library(FactoMineR)
library(factoextra)
library(CASdatasets)
library(tidyverse)
library(MASS)
library(knitr)
library(ggplot2)
library(cowplot)
library(reshape2)
library(dplyr)
library(GGally)
library(corrplot)
library(carData) 
library(car)
library(questionr)
library(multcomp)
library(dplyr)
library(leaps)
library(TeachingDemos)
library(FactoMineR)
library(factoextra)
library(ROCR)
library(plotROC)
```

## Documentation et import du dataset

```{r}
?CASdatasets #ouvre l'aide pour comprendre le dataset

data(freMPL5)

summary(freMPL5)

#Cette nouvelle covariable sera présentée plus tard
freMPL5$ObtLic <- ceiling(freMPL5$DrivAge - freMPL5$LicAge/12)

x <- freMPL5[, c(1,2,9,11,12,13,14,15,16,17,18,19,20, 21)]
corrplot(round(cor(x),2),method="ellipse")
```

freMPL veut dire French Motor Personal Line datasets. On utilisera le dataset 5 qui contient environ 26000 contrats de l'annee 2004.

On a ici un premier résumé des variables avec des premières corrélations.

On voit des fortes corrélations en valeur absolue entre BonusMalus, DrivAge et LicAge. Cela peut facilement se comprendre car l'âge du conducteur et le temps écoulé depuis qu'il a obtenu son permis sont souvent fortement lié. On pourrait d'ailleurs éventuellement créer une variable pour connaitre l'âge du conducteur lorsqu'il a obtenu le permis.

On remarque que certaines variables sont numériques au lieu d'être considérées comme des facteurs. Nous allons donc les changer :

```{r}
freMPL5$HasKmLimit <- factor(freMPL5$HasKmLimit)
freMPL5$ClaimInd <- factor(freMPL5$ClaimInd)
freMPL5$RiskArea <- factor(freMPL5$RiskArea)
freMPL5$ClaimNbResp <- factor(freMPL5$ClaimNbResp)
freMPL5$ClaimNbNonResp <- factor(freMPL5$ClaimNbNonResp)
freMPL5$ClaimNbParking <- factor(freMPL5$ClaimNbParking)
freMPL5$ClaimNbFireTheft <- factor(freMPL5$ClaimNbFireTheft)
freMPL5$ClaimNbWindscreen <- factor(freMPL5$ClaimNbWindscreen)
freMPL5$OutUseNb <- factor(freMPL5$OutUseNb)
```

### Coefficient de bonus-malus

Pour le coefficient de bonus-malus, il commence à 1 et peut descendre jusqu'à 0.5 si le conducteur n'a pas d'accidents responsables ou semi-responsables. A l'inverse, en cas d'accidents responsables, le coefficient augmente et peut atteindre jusqu'à 3.5. Dans le jeu de données, toutes les valeurs sont multipliées par 100 ce qui ne posera aucun problème dans le cas de nos modèles. Cependant, si on veut voir l'impact linéaire du coefficient de bonus-malus, il pourrait être intéressant de revoir son échelle en retranchant 100 par exemple à la variable. C'est pour cela qu'il y a une corrélation assez importante entre BonusMalus et ClaimNbResp.

Dans notre jeu de données, la valeur maximale est 1.85. Nous n'avons donc aucune information sur des éventuels assurés possédant un malus supérieur. Cela pourra donc être compliqué de prédire les primes d'assurances pour ce genre d'assurés. De manière générale, ici on a princialement des bons conducteurs puisque la médianne vaut 0.5 et le 3eme quartile 0.6 et 95% des assurés sont en dessous de 0.90.

```{r}
summary(freMPL5$BonusMalus)

quantile(freMPL5$BonusMalus, seq(0,1,0.05))
```

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$BonusMalus)
boxplot(freMPL5$BonusMalus ~ freMPL5$ClaimInd)
hist(freMPL5$BonusMalus[freMPL5$ClaimInd == 0])
hist(freMPL5$BonusMalus[freMPL5$ClaimInd == 1])
```

C'est surtout le boxplot qui permet de conclure à un lien car ceux qui ont à réclamer de l'argent ont en moyenne un Bonus plus faible que les autres.

##### Etude par rapport au coût

```{r}
fact_BonusMalus <- cut(freMPL5$BonusMalus, c(50,seq(51,120,10),350), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount ~ fact_BonusMalus, ylim=c(0,6000))
fact_BonusMalus_sinistre <- cut(freMPL5$BonusMalus[freMPL5$ClaimInd == 1], c(seq(50,59,1),seq(60,120,10),350), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1] ~ fact_BonusMalus_sinistre, ylim=c(0,15000))
```

Le premier graphique n'étant pas interprétable, nous avons créé le deuxieme qui semble nous donner une certaine tendance : plus le coefficient de malus est élevé et plus le coût moyen augmente.

### Etude de la variable d'âge (DrivAge)

```{r}
summary(freMPL5$DrivAge)
```

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$DrivAge)
hist(freMPL5$DrivAge[freMPL5$ClaimInd == 0])
summary(freMPL5$DrivAge[freMPL5$ClaimInd == 0])

hist(freMPL5$DrivAge[freMPL5$ClaimInd == 1])
summary(freMPL5$DrivAge[freMPL5$ClaimInd == 1])

boxplot(freMPL5$DrivAge ~ freMPL5$ClaimInd)

ggplot(freMPL5, aes(x = DrivAge)) +
  geom_histogram(aes(color = ClaimInd, fill = ClaimInd), 
                position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

L'âge du conducteur semble donc avoir un impact dans le risque d'avoir un sinistre (plus on est jeune, et plus on risque de coûter de l'argent à l'assurance). En effet, la proportion de 35-50 ans est très forte mais il n'y a pas beaucoup de sinistres pour autant comparé aux 20-30 ans.

##### Etude par rapport au coût

```{r}
plot(freMPL5$ClaimAmount ~ freMPL5$DrivAge)
freMPL5$DrivAge <- cut(freMPL5$DrivAge, quantile(freMPL5$DrivAge, probs = seq(0,1,1/6)), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount ~ freMPL5$DrivAge)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimAmount>0] ~ freMPL5$DrivAge[freMPL5$ClaimAmount>0], ylim=c(0,6000))
```

On observe donc un risque accru pour les jeunes conducteurs mais on remarque aussi que le risque augmente de nouveau après 50 ans (cela pourrait correspondre au moment où les enfants sont en âge de conduire sur le véhicule des parents).

### Etude de la variable d'ancienneté du permis (LicAge)

Cette variable est exprimée en mois. Nous rappelons qu'elle est très corrélée avec DrivAge et Bonus-Malus.

```{r}
summary(freMPL5$LicAge)
```

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$LicAge)

summary(freMPL5$LicAge[freMPL5$ClaimInd == 0])

summary(freMPL5$LicAge[freMPL5$ClaimInd == 1])

boxplot(freMPL5$LicAge ~ freMPL5$ClaimInd)

ggplot(freMPL5, aes(x = LicAge)) +
  geom_histogram(aes(color = ClaimInd, fill = ClaimInd), 
                position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

On retrouve à peu près les mêmes résultats ici que pour DrivAge. L'interprétation est la même.

##### Etude par rapport au coût

```{r}
plot(freMPL5$ClaimAmount ~ freMPL5$LicAge)
freMPL5$LicAge <- cut(freMPL5$LicAge, quantile(freMPL5$LicAge, probs = seq(0,1,1/6)), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount ~ freMPL5$LicAge)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimAmount>0] ~ freMPL5$LicAge[freMPL5$ClaimAmount>0], ylim=c(0,6000))
```

Idem que pour l'âge.

### Création d'une variable (ObtLic)

```{r}
#Rappel de la formule :
#freMPL5$ObtLic <- freMPL5$DrivAge - freMPL5$LicAge/12
summary(freMPL5$ObtLic)
```

On a des dates d'obtention de permis de 16 ans ? Ceci est étrange... Il faudra regarder dans les données :

```{r}
sum(ifelse(freMPL5$ObtLic<18,1,0))
```

Il n'y a que 13 valeurs incohérente, ce qui ne devrait pas beaucoup modifier l'analyse. Nous laisserons donc les données comme tel.

##### Etude par rapport à la sinistralité

```{r}
hist(freMPL5$ObtLic)

summary(freMPL5$ObtLic[freMPL5$ClaimInd == 0])

summary(freMPL5$ObtLic[freMPL5$ClaimInd == 1])

boxplot(freMPL5$ObtLic ~ freMPL5$ClaimInd)

ggplot(freMPL5, aes(x = ObtLic)) +
  geom_histogram(aes(color = ClaimInd, fill = ClaimInd), 
                position = "identity", bins = 30, alpha = 0.4) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  scale_fill_manual(values = c("#00AFBB", "#E7B800"))
```

Il ne semble pas y avoir ici d'impact particulier.

##### Etude par rapport au coût

```{r}
plot(freMPL5$ClaimAmount ~ freMPL5$ObtLic)
freMPL5$ObtLic <- cut(freMPL5$ObtLic, quantile(freMPL5$ObtLic, probs = seq(0,1,1/6)), include.lowest = TRUE)
boxplot(freMPL5$ClaimAmount ~ freMPL5$ObtLic)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimAmount>0] ~ freMPL5$ObtLic[freMPL5$ClaimAmount>0], ylim=c(0,6000))
```

Il n'y a pas de claire tendance une nouvelle fois. Cette variable ne sera sûrement pas utile par la suite.

### Exposition

### Date de début

### Date de fin

### Genre

##### Etude par rapport à la sinistralité

```{r}
summary(freMPL5$Gender)

#create the contingency table
Gender_contingence <- table(freMPL5$Gender, freMPL5$ClaimInd)
Gender_contingence


#Création d'un camembert pour les non-sinistres

x_1=c(Gender_contingence[1,1]/(Gender_contingence[1,1]+Gender_contingence[1,2]),Gender_contingence[2,1]/(Gender_contingence[2,1]+Gender_contingence[2,2]))
labels_1=c("Female","Male")

df_1=data.frame(x_1,
              labels_1)


ggplot(df_1, aes(x="", y=x_1, fill=labels_1)) +geom_bar(width = 1, stat = "identity") + coord_polar("y", start=0) +theme_void()+ggtitle("Proportion de non sinistre par genre")

#Création d'un camembert pour les sinistres

x_2=c(Gender_contingence[1,2]/(Gender_contingence[1,1]+Gender_contingence[1,2]),Gender_contingence[2,2]/(Gender_contingence[2,1]+Gender_contingence[2,2]))
labels_2=c("Female","Male")

df_2=data.frame(x_2,
              labels_2)

ggplot(df_2, aes(x="", y=x_2, fill=labels_2)) +geom_bar(width = 1, stat = "identity") + coord_polar("y", start=0) +theme_void()+ggtitle("Proportion de sinsitre par genre")


```

Il est important de remarquer que l'échantillon contient deux fois plus d'hommes que de femmes. Les camemberts sont obtenus en prenant en compte la pondération de chaque genre au sein du groupe d'individus

```{r}

```

```{r}

```

Le groupe constitué des hommes ayant commis un sinistre semble réclamé les mêmes montants que le groupe constitué des femmes ayant commis un sinistre. Il n'a y pas de distinction flagrante entre les sexes.

### Statut marital

```{r}
summary(freMPL5$MariStat)
```

##### Etude par rapport à la sinistralité

```{r}
#create the contingency table
MariStat_contingence <- table(freMPL5$MariStat, freMPL5$ClaimInd)
MariStat_contingence


#Création d'un camembert pour les non-sinistres

x_1=c(MariStat_contingence[1,1]/(MariStat_contingence[1,1]+MariStat_contingence[1,2]),MariStat_contingence[2,1]/(MariStat_contingence[2,1]+MariStat_contingence[2,2]))
labels_1=c("Alone","Other")

df_1=data.frame(x_1,
              labels_1)


ggplot(df_1, aes(x="", y=x_1, fill=labels_1)) +geom_bar(width = 1, stat = "identity") + coord_polar("y", start=0) +theme_void()+ggtitle("Proportion de non sinistre par statut marital")

#Création d'un camembert pour les sinistres

x_2=c(MariStat_contingence[1,2]/(MariStat_contingence[1,1]+MariStat_contingence[1,2]),MariStat_contingence[2,2]/(MariStat_contingence[2,1]+MariStat_contingence[2,2]))
labels_2=c("Alone","Other")

df_2=data.frame(x_2,
              labels_2)

ggplot(df_2, aes(x="", y=x_2, fill=labels_2)) +geom_bar(width = 1, stat = "identity") + coord_polar("y", start=0) +theme_void()+ggtitle("Proportion de sinsitre par statut marital")


```

Les gens seuls semblent être légèrement plus impliqués dans des sinistres que les autres individus. Cela peut s'expliquer par une prise de risque plus importante sur les routes.

```{r}
boxplot(freMPL5$ClaimAmount ~ freMPL5$MariStat)
boxplot(freMPL5$ClaimAmount[freMPL5$ClaimAmount>0] ~ freMPL5$MariStat[freMPL5$ClaimAmount>0], ylim=c(0,10000))
```

Les deux groupes partagent la même médiane. Cependant, on observe que les gens seuls ont tendance à réclamer des montants plus élevés. On peut expliquer cela par le fait que ces derniers prennent plus de risque sur la route et peuvent donc être impliqués dans des sinistres plus élevés.

### CSP

Cette catégorie devra être regroupée car elle contient trop de modalités de facteur.

```{r}
summary(freMPL5$SocioCateg)
```

##### Etude par rapport à la sinistralité 

```{r}

tab=table(freMPL5$SocioCateg,freMPL5$ClaimInd)
cols=rainbow(nlevels(freMPL5$ClaimInd))
plot(tab,col=cols)

#create the contingency table
Socio_contingence <- table(freMPL5$SocioCateg, freMPL5$ClaimInd)
Socio_contingence

#Création d'un camembert pour les sinistres
k=data.frame()
x_2=for(i in range(33)){k<-c(k,Socio_contingence[i,1])}
x_2

q=data.frame(1)
q=c(q,4)
q
c(list(),Socio_contingence[2,1],Socio_contingence[10,1])
labels_2=c("Alone","Other")

df_2=data.frame(x_2,
              labels_2)

ggplot(df_2, aes(x="", y=x_2, fill=labels_2)) +geom_bar(width = 1, stat = "identity") + coord_polar("y", start=0) +theme_void()+ggtitle("Proportion de sinsitre par statut marital")



```

### Utilisation du véhicule

### Limite kilométrique

### Zone de risque

Cette catégorie devra être regroupée (idem CSP)

### Accident responsable

### Accident non-responsable

### Parking

### Incendie ou vol

### Bris de glace

### Panne

### Etude de la variables coût

##### ...en fonction de la sinistralité

```{r echo=TRUE}
plot(freMPL5$ClaimAmount ~ freMPL5$ClaimInd)
```

```{r echo=TRUE}
summary(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1]) #resumé lorsque de l'argent est demandé
summary(freMPL5$ClaimAmount[freMPL5$ClaimInd == 0])
```

On remarque donc l'apparition de quelques données étranges. En effet, on a l'apparition de variables de coût négatives. Ceci est du à une régularisation. ne pouvant pas traiter cela, nous supprimerons les lignes correspondantes qui sont au nombre de 278.

```{r}
sum(ifelse(freMPL5$ClaimAmount[freMPL5$ClaimInd == 0]<0,1,0)) #=278
```

Nous supprimons alors les lignes en questions :

```{r}
freMPL5 <- subset(freMPL5, freMPL5$ClaimAmount >= 0)
```

Nous avons autrement une distribution des coût qui est relativement proche de 0 avec tout de même l'apparition de quelques sinistres graves qui faussent la moyenne :

```{r}
hist(freMPL5$ClaimAmount) #écrasé par 0 car il y a énormément de petits sinistres
hist(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1]) #de nouveau écrasé dans les petites valeurs
```

Pour mieux voir la potentielle distribution, nous allons essayer de zoomer vers les petites valeurs :

```{r}
hist(freMPL5$ClaimAmount[freMPL5$ClaimInd == 1], breaks=seq(0,100000,10),xlim=c(0,4000))
```

On a ici un graphique plus intéressant qui nous permettra de proposer éventuellement une loi pour la variable de coût. On remarque tout de fois quelques énormes pics de fréquence. Nous pouvons imaginer qu'il s'agit d'une dépense forfaitaire (comme par exemple un bris de glace qui s'en rapproche à cause de Carglass en France).

On remarque un premier pic entre 90 et 110 et un autre 1410 et 1420. Regardons à quoi cela pourrait être dû :

```{r}
summary(freMPL5[freMPL5$ClaimAmount<110 & freMPL5$ClaimAmount>90,])
```

On remarque que cette tranche représente 8,7% des assurés qui ont eu recours à un remboursement.

### Etude de la variable d'indication de remboursement

```{r}
summary(freMPL5[freMPL5$ClaimInd == 0,])
summary(freMPL5[freMPL5$ClaimInd == 1,])
```

On remarque que LicAge et DrivAge réduisent le risque d'avoir un sinistre.

De même, plus le score de malus est haut et plus l'assuré a de risque d'avoir un sinistre.

Avoir une limite de kilomètres semblent aussi réduire les risques.

Pour les catégories sociaux-professionnelles, il faudra faire une étude plus poussée avant de conclure.
